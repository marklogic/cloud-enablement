{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "9.0-3",
    "parameters": {
        "DeploymentName": {
            "type": "string",
            "minLength": 0,
            "maxLength": 10,
            "metadata": {
                "description": "The value will be used as prefix for all resources. Limit to 10 characters and spaces will be removed."
            }
        },
        "AdminUser": {
            "type": "secureString",
            "minLength": 0,
            "metadata": {
                "description": "The MarkLogic administrator user name"
            }
        },
        "AdminPassword": {
            "type": "secureString",
            "minLength": 0,
            "metadata": {
                "description": "The MarkLogic administrator password"
            }
        },
        "Licensee": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "none",
            "metadata": {
                "description": "The MarkLogic Licensee or 'none' for developer license"
            }
        },
        "LicenseKey": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "none",
            "metadata": {
                "description": "The MarkLogic License Key or 'none' for developer license"
            }
        },
        "NumberOfNodes": {
            "type": "int",
            "defaultValue": 3,
            "allowedValues": [1,3],
            "metadata": {
                "description": "Number of nodes in the cluster"
            }
        },
        "AvailabilitySet": {
            "type": "string",
            "defaultValue": "enable",
            "allowedValues": ["enable", "disable"],
            "metadata": {
                "description": "Whether to put virtual machines in an Availability Set. Only applicable to multi-node cluster"
            }
        },
        "LoadBalancer": {
            "type": "string",
            "defaultValue": "public",
            "allowedValues": ["public", "internal"],
            "metadata": {
                "description": "Type of load balancer to use"
            }
        },
        "OSStorage": {
            "type": "string",
            "defaultValue": "premium",
            "allowedValues": ["premium", "standard"],
            "metadata": {
                "description": "Storage type for operating system of virtual machines"
            }
        },
        "DataStorage": {
            "type": "string",
            "defaultValue": "premium",
            "allowedValues": ["premium", "standard"],
            "metadata": {
                "description": "Storage type for data directory of virtual machines"
            }
        },
        "VirtualMachineUser": {
            "type": "secureString",
            "minLength": 0,
            "metadata": {
                "description": "Operating system user name for virtual machines"
            }
        },
        "SSHPublicKey": {
            "type": "secureString",
            "minLength": 0,
            "metadata": {
                "description": "Public SSH key for virtual machine user specified"
            }
        },
        "InstanceType": {
            "type": "string",
            "defaultValue": "Standard_DS1_v2",
            "allowedValues": 
            [
                "Basic_A2",
                "Basic_A3",
                "Basic_A4",
                "Standard_A10",
                "Standard_A11",
                "Standard_A2",
                "Standard_A2_v2",
                "Standard_A2m_v2",
                "Standard_A3",
                "Standard_A4",
                "Standard_A4_v2",
                "Standard_A4m_v2",
                "Standard_A5",
                "Standard_A6",
                "Standard_A7",
                "Standard_A8",
                "Standard_A8_v2",
                "Standard_A8m_v2",
                "Standard_A9",
                "Standard_B2s",
                "Standard_D1",
                "Standard_D11",
                "Standard_D11_v2",
                "Standard_D11_v2_Promo",
                "Standard_D12",
                "Standard_D12_v2",
                "Standard_D12_v2_Promo",
                "Standard_D13",
                "Standard_D13_v2",
                "Standard_D13_v2_Promo",
                "Standard_D14",
                "Standard_D14_v2",
                "Standard_D14_v2_Promo",
                "Standard_D15_v2",
                "Standard_D16_v3",
                "Standard_D16s_v3",
                "Standard_D1_v2",
                "Standard_D2",
                "Standard_D2_v2",
                "Standard_D2_v2_Promo",
                "Standard_D2_v3",
                "Standard_D2s_v3",
                "Standard_D3",
                "Standard_D32_v3",
                "Standard_D32s_v3",
                "Standard_D3_v2",
                "Standard_D3_v2_Promo",
                "Standard_D4",
                "Standard_D4_v2",
                "Standard_D4_v2_Promo",
                "Standard_D4_v3",
                "Standard_D4s_v3",
                "Standard_D5_v2",
                "Standard_D5_v2_Promo",
                "Standard_D64_v3",
                "Standard_D64s_v3",
                "Standard_D8_v3",
                "Standard_D8s_v3",
                "Standard_DS1",
                "Standard_DS11",
                "Standard_DS11_v2",
                "Standard_DS11_v2_Promo",
                "Standard_DS12",
                "Standard_DS12_v2",
                "Standard_DS12_v2_Promo",
                "Standard_DS13",
                "Standard_DS13_v2",
                "Standard_DS13_v2_Promo",
                "Standard_DS14",
                "Standard_DS14_v2",
                "Standard_DS14_v2_Promo",
                "Standard_DS15_v2",
                "Standard_DS1_v2",
                "Standard_DS2",
                "Standard_DS2_v2",
                "Standard_DS2_v2_Promo",
                "Standard_DS3",
                "Standard_DS3_v2",
                "Standard_DS3_v2_Promo",
                "Standard_DS4",
                "Standard_DS4_v2",
                "Standard_DS4_v2_Promo",
                "Standard_DS5_v2",
                "Standard_DS5_v2_Promo",
                "Standard_E16_v3",
                "Standard_E16s_v3",
                "Standard_E2_v3",
                "Standard_E2s_v3",
                "Standard_E32_v3",
                "Standard_E32s_v3",
                "Standard_E4_v3",
                "Standard_E4s_v3",
                "Standard_E64_v3",
                "Standard_E64s_v3",
                "Standard_E8_v3",
                "Standard_E8s_v3",
                "Standard_F16",
                "Standard_F16s",
                "Standard_F2",
                "Standard_F2s",
                "Standard_F4",
                "Standard_F4s",
                "Standard_F8",
                "Standard_F8s",
                "Standard_G1",
                "Standard_G2",
                "Standard_G3",
                "Standard_G4",
                "Standard_G5",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS5",
                "Standard_H16",
                "Standard_H16m",
                "Standard_H16mr",
                "Standard_H16r",
                "Standard_H8",
                "Standard_H8m",
                "Standard_L16s",
                "Standard_L32s",
                "Standard_L4s",
                "Standard_L8s",
                "Standard_M128s",
                "Standard_M64ms",
                "Standard_M64s",
                "Standard_NC12",
                "Standard_NC24",
                "Standard_NC24r",
                "Standard_NC6",
                "Standard_NV12",
                "Standard_NV24",
                "Standard_NV6"
            ],
            "metadata": {
                "description": "Type of virtual machine to launch. The list only includes instance types that meet minimum requirement of MarkLogic Server"
            }
        },
        "HighAvailability": {
            "type": "string",
            "defaultValue": "enable",
            "allowedValues": ["enable","disable"],
            "metadata": {
                "description": "Configure local-disk failover. Only applicable to multi-node cluster"
            }
        },
        "baseUrl": {
            "type": "string",
            "metadata": {
                "description": "The base URL for dependent assets"
            },
            "minLength": 0,
            "defaultValue": "https://s3-us-west-2.amazonaws.com/mattsun-s3-bucket/cloud-enablement"
        }
    },
    "variables": {
        "templateVersion": "9.0-3",
        "repositoryUrl": "[concat(parameters('baseUrl'),'/azure/']",
        "templateBaseUrl": "[concat(variables('repositoryUrl'),'templates/')]",
        "scriptBaseUrl": "[concat(variables('repositoryUrl'),'scripts/')]",
        "clusterPrefix": "[replace(parameters('DeploymentName'),' ','')]",
        "clusterLocation": "[resourceGroup().location]",
        "enableAvailabilitySet": "[if(lessOrEquals(parameters('NumberOfNodes'),1),bool('false'),equals(parameters('AvailabilitySet'),'enable'))]",
        "enableLbIpv6": true,
        "enableHA": "[if(lessOrEquals(parameters('NumberOfNodes'),1),bool('false'),equals(parameters('HighAvailability'),'enable'))]",
        "license": "[if(and(equals(parameters('Licensee'),'none'),equals(parameters('LicenseKey'),'none')),'DEV','BYOL')]",
        "imageOffer": "[if(equals(variables('license'),'DEV'),'marklogic-developer-9','marklogic-9-byol')]",
        "imageSku": "[if(equals(variables('license'),'DEV'),'ml903_centos','ml903_centos_byol')]",
        "apiVersions": {
            "resourcesApiVersion": "2016-09-01",
            "networkApiVersion": "2017-08-01",
            "storageApiVersion": "2017-03-30",
            "computeApiVersion": "2017-03-30"
        },
        "templateUrls": {
            "availabilitySetTemplateUrl": "[concat(variables('templateBaseUrl'),'availabilitySet.json')]",
            "vnetTemplateUrl": "[concat(variables('templateBaseUrl'),'virtualNetwork.json')]",
            "nodePublicIpTemplateUrl": "[concat(variables('templateBaseUrl'),'nodePublicIp.json')]",
            "nsgTemplateUrl": "[concat(variables('templateBaseUrl'),'networkSecurityGroup.json')]",
            "networkInterfaceTemplateUrl": "[concat(variables('templateBaseUrl'),'networkInterface.json')]",
            "vmTemplateUrl": "[concat(variables('templateBaseUrl'),'virtualMachine.json')]",
            "bootstrapNodeExtTemplateUrl": "[concat(variables('templateBaseUrl'),'bootstrapNodeExt.json')]",
            "additionalNodeExtTemplateUrl": "[concat(variables('templateBaseUrl'),'additionalNodeExt.json')]",
            "lbTemplateUrl": "[concat(variables('templateBaseUrl'),'loadBalancer.json')]"
        },
        "scriptUrls": {
            "bootstrapNodeScriptUrl": "[concat(variables('scriptBaseUrl'),'config-bootstrap-node.sh')]",
            "additionalNodeScriptUrl": "[concat(variables('scriptBaseUrl'),'config-additional-node.sh')]",
            "highAvailabilityScriptUrl": "[concat(variables('scriptBaseUrl'),'high-availability.sh')]",
            "haExtXqyUrl": "[concat(variables('scriptBaseUrl'),'configure-ha.txt')]",
            "initScriptUrl": "[concat(variables('scriptBaseUrl'),'init.sh')]"
        },
        "availabilitySetSetting": {
            "name": "[concat(variables('clusterPrefix'),'-availset')]",
            "location": "[variables('clusterLocation')]",
            "updateDomainCount": "20",
            "faultDomainCount": "3",
            "apiVersion": "[variables('apiVersions').computeApiVersion]"
        },
        "vnetSetting": {
            "name": "[concat(variables('clusterPrefix'),'-vnet')]",
            "location": "[variables('clusterLocation')]",
            "vnetPrefix": "10.0.0.0/16",
            "vnetSubnetName": "[concat(variables('clusterPrefix'),'-vnet-subnet')]",
            "vnetSubnetPrefix": "10.0.1.0/24",
            "apiVersion": "[variables('apiVersions').networkApiVersion]"
        },
        "nsgSetting": {
            "name": "[concat(variables('clusterPrefix'),'-nsg')]",
            "location": "[variables('clusterLocation')]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]"
        },
        "nodePublicIpSetting": {
            "name": "[concat(variables('clusterPrefix'),'-ip')]",
            "location": "[variables('clusterLocation')]",
            "domainNameLabel": "[concat(variables('clusterPrefix'),'-',uniqueString(concat(variables('clusterPrefix'),resourceGroup().id)),'-')]",
            "IPv4AllocationMethod": "Static",
            "IPv6AllocationMethod": "Dynamic",
            "idleTimeout": "4",
            "count": "[parameters('NumberOfNodes')]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]"
        },
        "networkInterfaceSetting": {
            "name": "[concat(variables('clusterPrefix'),'-networkInterface')]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]",
            "location": "[variables('clusterLocation')]",
            "count":  "[parameters('NumberOfNodes')]",
            "vnetName": "[variables('vnetSetting').name]",
            "subnetName": "[variables('vnetSetting').vnetSubnetName]",
            "nodePublicIpName": "[variables('nodePublicIpSetting').name]",
            "nsgName": "[variables('nsgSetting').name]",
            "lbName": "[variables('lbSetting').name]",
            "lbBackendPoolIpv4Name": "[concat(variables('lbSetting').lbBackendPoolName,'-v4')]",
            "lbBackendPoolIpv6Name": "[concat(variables('lbSetting').lbBackendPoolName,'-v6')]"
        },
        "lbSetting": {
            "name": "[concat(variables('clusterPrefix'),'-lb')]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]",
            "location": "[variables('clusterLocation')]",
            "lbIpConfigName": "[concat(variables('clusterPrefix'),'-lbIpConfig')]",
            "lbBackendPoolName": "[concat(variables('clusterPrefix'),'-lbBackendPool')]",
            "probeName": "[concat(variables('clusterPrefix'),'-lbProbe')]",
            "vnetName": "[variables('vnetSetting').name]",
            "subnetName": "[variables('vnetSetting').vnetSubnetName]",
            "type": "[parameters('LoadBalancer')]"
        },
        "publicLBIpSetting": {
            "name": "[concat(variables('lbSetting').name,'Ip')]",
            "enableIpv6": "[variables('enableLbIpv6')]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]",
            "location": "[variables('clusterLocation')]",
            "IPAllocationMethod": "Static",
            "domainNameLabel": "[concat(variables('clusterPrefix'),'-',uniqueString(concat(variables('clusterPrefix'),resourceGroup().id)),'-lb')]"
        },
        "vmSetting": {
            "location": "[variables('clusterLocation')]",
            "count": "[parameters('NumberOfNodes')]",

            "diagnoStorageAcctName": "[concat(toLower(variables('clusterPrefix')),'diagnostorageacct')]",
            "storageApiVersion": "[variables('apiVersions').storageApiVersion]",
            "diagnoStorageAccType": "Standard_RAGRS",

            "dataDiskName": "[concat(variables('clusterPrefix'),'-disk')]",
            "dataDiskCreateOption": "Empty",
            "dataDiskAcctType": "[if(equals(parameters('DataStorage'),'standard'),'Standard_LRS','Premium_LRS')]",
            "dataDiskSizeGB": 1023,

            "computeApiVersion": "[variables('apiVersions').computeApiVersion]",
            "vmName": "[concat(variables('clusterPrefix'),'-vm')]",
            "imagePublisher": "marklogic",
            "imageOffer": "[variables('imageOffer')]",
            "imageSku": "[variables('imageSku')]",
            "imageVersion": "latest",
            "availabilitySetName": "[variables('availabilitySetSetting').name]",
            "enableAvailabilitySet": "[variables('enableAvailabilitySet')]",
            "vmSize": "[parameters('InstanceType')]",
            "adminUsername": "[parameters('VirtualMachineUser')]",
            "sshKey": "[parameters('SSHPublicKey')]",
            "osDiskAcctType": "[if(equals(parameters('OSStorage'),'standard'),'Standard_LRS','Premium_LRS')]",
            "networkInterfaceName": "[variables('networkInterfaceSetting').name]"
        },
        "bootstrapNodeExtSetting": {
            "vmName": "[variables('vmSetting').vmName]",
            "apiVersion": "[variables('apiVersions').computeApiVersion]",
            "location": "[variables('clusterLocation')]",
            "bootstrapNodeScriptUrl": "[variables('scriptUrls').bootstrapNodeScriptUrl]",
            "initScriptUrl": "[variables('scriptUrls').initScriptUrl]",
            "dnsPrefix": "[variables('nodePublicIpSetting').domainNameLabel]",
            "cmdPrefix": "[concat('sudo sh config-bootstrap-node.sh ',parameters('AdminUser'),' ''',parameters('AdminPassword'),''' anyauth 5 10 public ',parameters('LicenseKey'),' ',parameters('Licensee'))]"
        },
        "additionalNodeExtSetting": {
            "vmName": "[variables('vmSetting').vmName]",
            "apiVersion": "[variables('apiVersions').computeApiVersion]",
            "location": "[variables('clusterLocation')]",
            "additionalNodeExtCount": "[sub(parameters('NumberOfNodes'),1)]",
            "additionalNodeScriptUrl": "[variables('scriptUrls').additionalNodeScriptUrl]",
            "initScriptUrl": "[variables('scriptUrls').initScriptUrl]",
            "vmLocation": "[variables('vmSetting').location]",
            "dnsPrefix": "[variables('nodePublicIpSetting').domainNameLabel]",
            "haExtXqyUrl": "[variables('scriptUrls').haExtXqyUrl]",
            "highAvailabilityScriptUrl": "[variables('scriptUrls').highAvailabilityScriptUrl]",
            "cmdPrefix": "[concat('sudo sh config-additional-node.sh ',parameters('AdminUser'),' ''',parameters('AdminPassword'),''' anyauth 5 10 ',string(variables('enableHA')),' ',parameters('LicenseKey'),' ',parameters('Licensee'))]"
        }
    },
    "resources": [
        {
            "name": "availabilitySetDeployment",
            "condition": "[variables('enableAvailabilitySet')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').availabilitySetTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "availabilitySetSetting": {
                        "value": "[variables('availabilitySetSetting')]"
                    }
                }
            }
        },
        {
            "name": "vnetDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').vnetTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "vnetSetting": {
                        "value": "[variables('vnetSetting')]"
                    }
                }
            }
        },
        {
            "name": "nodePublicIpDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').nodePublicIpTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "nodePublicIpSetting": {
                        "value": "[variables('nodePublicIpSetting')]"
                    }
                }
            }
        },
        {
            "name": "nsgDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').nsgTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "nsgSetting": {
                        "value": "[variables('nsgSetting')]"
                    }
                }
            }
        },
        {
            "name": "loadBalancerDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').lbTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "lbSetting": {
                        "value": "[variables('lbSetting')]"
                    },
                    "publicLBIpSetting": {
                        "value": "[variables('publicLBIpSetting')]"
                    }
                }
            }
        },
        {
            "name": "networkInterfaceDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "dependsOn": [
                "vnetDeployment",
                "nodePublicIpDeployment",
                "nsgDeployment",
                "loadBalancerDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').networkInterfaceTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "networkInterfaceSetting": {
                        "value": "[variables('networkInterfaceSetting')]"
                    }
                }
            }
        },
        {
            "name": "virtualMachineDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "dependsOn": [
                "networkInterfaceDeployment",
                "availabilitySetDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').vmTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "vmSetting": {
                        "value": "[variables('vmSetting')]"
                    }
                }
            }
        },
        {
            "name": "bootstrapNodeExtDeployment",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "dependsOn": [
                "virtualMachineDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').bootstrapNodeExtTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "extSetting": {
                        "value": "[variables('bootstrapNodeExtSetting')]"
                    }
                }
            }
        },
        {
            "name": "additionalNodeExtDeployment",
            "type": "Microsoft.Resources/deployments",
            "condition": "[greater(parameters('NumberOfNodes'),1)]",
            "apiVersion": "[variables('apiVersions').resourcesAPIVersion]",
            "dependsOn": [
                "bootstrapNodeExtDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('templateUrls').additionalNodeExtTemplateUrl]",
                    "contentVersion": "[variables('templateVersion')]"
                },
                "parameters": {
                    "extSetting": {
                        "value": "[variables('additionalNodeExtSetting')]"
                    }
                }
            }
        }
    ]
}